<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Office Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <style>
    body { margin:0; padding:0; display:flex; height:100vh; font-family: Arial, sans-serif; }
    #sidebar { width:280px; background:#f8f8f8; padding:15px; overflow-y:auto; box-shadow:2px 0 5px rgba(0,0,0,0.1); }
    #map { flex:1; }
    h3 { margin-top:0; }
    label { display:block; margin-top:12px; font-weight:bold; }
    select, input[type="color"], input[type="file"], button { width:100%; margin-top:6px; padding:6px; }
    .subhead { font-size:12px; font-weight:normal; color:#555; margin-top:2px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Filters</h3>
    <label>Filter by State/Province
      <div class="subhead">(hold Ctrl + click to select multiple states/provinces)</div>
      <select id="stateFilter" multiple size="8"></select>
    </label>
    <label>Filter by Business Unit
      <select id="buFilter" multiple size="5"></select>
    </label>
    <label>Marker Color
      <div class="subhead">for uploaded addresses</div>
      <input type="color" id="markerColor" value="#000086">
    </label>
    <label>Upload Addresses
      <input type="file" id="fileInput" accept=".csv">
    </label>
    <button id="revertBtn">Revert to Original Map</button>
    <button id="exportBtn">Export Map as PNG</button>
  </div>
  <div id="map"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    mapboxgl.accessToken = "pk.eyJ1IjoiamFjcXVlbGlja3RlaWciLCJhIjoiY2xibGk4dzI4MDFndjNvcGZiMWJ0Z2g1aCJ9.JEUK4ec6CII_v5q0v2iXJA";

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/jacquelickteig/cm19xymc400tt01pde8ul6loi',
      center: [-98, 38],
      zoom: 3
    });

    const GOOGLE_MAPS_KEY = "AIzaSyBdVVKVelSKtsN9F6wTh-S57j-r1TbvNXw";

    let uploadedMarkers = [];

    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      Papa.parse(file, {
        header: true,
        complete: async function(results) {
          clearUploadedMarkers();
          for (const row of results.data) {
            if (!row.ADDRESS) continue;
            let lat = row.Latitude, lng = row.Longitude;
            if (!lat || !lng) {
              try {
                const resp = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(row.ADDRESS)}&key=${GOOGLE_MAPS_KEY}`);
                const data = await resp.json();
                if (data.status === "OK") {
                  lat = data.results[0].geometry.location.lat;
                  lng = data.results[0].geometry.location.lng;
                }
              } catch(e) { console.error(e); }
            }
            if (lat && lng) {
              const color = document.getElementById("markerColor").value;
              const marker = new mapboxgl.Marker({ color }).setLngLat([lng, lat]).setPopup(new mapboxgl.Popup().setText(row["Client and Project Name"] || row.ADDRESS)).addTo(map);
              uploadedMarkers.push(marker);
            }
          }
        }
      });
    });

    document.getElementById("markerColor").addEventListener("input", function(e) {
      const newColor = e.target.value;
      uploadedMarkers.forEach(m => {
        const el = m.getElement().querySelector("svg path");
        if (el) el.setAttribute("fill", newColor);
      });
    });

    function clearUploadedMarkers() {
      uploadedMarkers.forEach(m => m.remove());
      uploadedMarkers = [];
    }

    document.getElementById("revertBtn").addEventListener("click", () => {
      clearUploadedMarkers();
      document.getElementById("fileInput").value = "";
      document.getElementById("markerColor").value = "#000086";
      document.getElementById("stateFilter").selectedIndex = -1;
      document.getElementById("buFilter").selectedIndex = -1;
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      html2canvas(document.getElementById("map"), {useCORS: true}).then(canvas => {
        const link = document.createElement("a");
        link.download = "map.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    });
  </script>
</body>
</html>
