<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Salas O'Brien Offices Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- html2canvas for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <!-- Pickr (Color Picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
  
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #filters {
      position:absolute;
      top:10px; left:10px;
      background:#fff; padding:10px; border-radius:4px;
      font-family:sans-serif; z-index:1;
      max-width:260px;
    }
    label { font-weight:bold; margin-bottom:8px; }
    .subhead { font-weight:normal; font-size:12px; display:block; margin-top:-2px; margin-bottom:8px; }
    select { margin:5px 0; width:100%; }
    button { margin:5px 0; padding:5px 10px; width:100%; }
    input[type="file"] { margin:5px 0; width:100%; }
    .mapboxgl-popup { font-family: sans-serif; font-size: 13px; }
    .mapboxgl-popup-content { white-space: pre-line; }
    #color-picker { margin-top:5px; margin-bottom:10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="filters">
    <label for="regionSelect">State / Province</label>
    <span class="subhead">Filter by region</span>
    <select id="regionSelect" multiple></select>

    <label for="buSelect">Business Unit</label>
    <span class="subhead">Filter by BU</span>
    <select id="buSelect" multiple></select>

    <label>Upload Additional Addresses</label>
    <span class="subhead">Project or Client Locations</span>
    <input type="file" id="csvUpload" accept=".csv" />
    <button id="downloadTemplate">Download Template CSV</button>

    <label>Marker Color</label>
    <span class="subhead">(for uploaded addresses)</span>
    <div id="color-picker"></div>

    <button id="revertMap">Revert to Original Map</button>
    <button id="exportMap">Export Map as Image</button>
  </div>

  <script>
    mapboxgl.accessToken = "YOUR_MAPBOX_TOKEN";
    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v12",
      center: [-98.5795, 39.8283],
      zoom: 3
    });

    let originalGeojson = { "type": "FeatureCollection", "features": [] };
    let uploadedLayerId = "uploaded-points";

    // Pickr setup
    const pickr = Pickr.create({
      el: '#color-picker',
      theme: 'classic',
      default: '#000086',
      components: {
        preview: true,
        opacity: true,
        hue: true,
        interaction: {
          hex: true,
          rgba: true,
          input: true,
          save: true
        }
      }
    });

    let markerColor = "#000086";
    pickr.on('save', (color) => {
      markerColor = color.toHEXA().toString();
      if (map.getLayer(uploadedLayerId)) {
        map.setPaintProperty(uploadedLayerId, 'circle-color', markerColor);
      }
    });

    // CSV Upload
    document.getElementById('csvUpload').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        const text = event.target.result;
        const rows = text.split("\n").map(r => r.split(","));
        const headers = rows[0];
        const addressIndex = headers.indexOf("ADDRESS");
        const features = rows.slice(1).map(row => {
          return {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [Number(row[headers.indexOf("Longitude")]), Number(row[headers.indexOf("Latitude")])]
            },
            properties: {
              name: row[headers.indexOf("OFFICE NAME")] || "New Location"
            }
          };
        }).filter(f => !isNaN(f.geometry.coordinates[0]) && !isNaN(f.geometry.coordinates[1]));

        const uploadedGeojson = { type: "FeatureCollection", features };

        if (map.getLayer(uploadedLayerId)) {
          map.removeLayer(uploadedLayerId);
          map.removeSource(uploadedLayerId);
        }

        map.addSource(uploadedLayerId, { type:"geojson", data: uploadedGeojson });
        map.addLayer({
          id: uploadedLayerId,
          type: "circle",
          source: uploadedLayerId,
          paint: { "circle-radius": 6, "circle-color": markerColor }
        });

        // Popups for uploaded points
        map.on("click", uploadedLayerId, (e) => {
          const coords = e.features[0].geometry.coordinates.slice();
          const name = e.features[0].properties.name;
          new mapboxgl.Popup()
            .setLngLat(coords)
            .setHTML("<strong>" + name + "</strong>")
            .addTo(map);
        });
      };
      reader.readAsText(file);
    });

    // Revert button
    document.getElementById('revertMap').addEventListener('click', () => {
      if (map.getLayer(uploadedLayerId)) {
        map.removeLayer(uploadedLayerId);
        map.removeSource(uploadedLayerId);
      }
      pickr.setColor("#000086");
      document.getElementById('csvUpload').value = "";
      if (map.getSource('offices')) {
        map.getSource('offices').setData(originalGeojson);
      }
    });

    // Export map
    document.getElementById('exportMap').addEventListener('click', () => {
      html2canvas(document.querySelector("#map")).then(canvas => {
        const link = document.createElement('a');
        link.download = "map.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    });

    // Force CSV download
    document.getElementById('downloadTemplate').addEventListener('click', () => {
      const url = "https://raw.githubusercontent.com/JLickteig/SalasOBrienOfficeMap/refs/heads/main/MapAddressTemplate.csv";
      const a = document.createElement('a');
      a.href = url;
      a.download = "MapAddressTemplate.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>
</body>
</html>
