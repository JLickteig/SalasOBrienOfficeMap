<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Salas O'Brien Offices Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #filters {
      position:absolute;
      top:10px; left:10px;
      background:#fff; padding:10px; border-radius:4px;
      font-family:sans-serif; z-index:1;
      max-width:260px;
    }
    label { font-weight:bold; }
    select { margin:5px 0; width:100%; }
    button { margin:5px 0; padding:5px 10px; }
    input[type="file"], input[type="color"] { margin:5px 0; }
    .mapboxgl-popup { font-family: sans-serif; font-size: 13px; }
    .mapboxgl-popup-content { white-space: pre-line; }
  </style>
</head>
<body>
<div id="filters">
  <label>Filter by State</label><br>
  <select id="stateFilter" multiple size="5"></select><br>

  <label>Filter by Province</label><br>
  <select id="provinceFilter" multiple size="5"></select><br>

  <label>Filter by Business Unit</label><br>
  <select id="buFilter" multiple size="5"></select><br>

  <button id="clearFilters">Clear Filters</button>
  <hr>

  <label>Upload CSV of Offices</label><br>
  <input type="file" id="csvUpload" accept=".csv"><br>
  <label>Marker Color</label><br>
  <input type="color" id="colorPicker" value="#ff0000"><br>
  <button id="revertMap">Revert to Original Map</button>
</div>
<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiamFjcXVlbGlja3RlaWciLCJhIjoiY21lZDF0aXE0MDVrYzJpcGxxYWJjcjBkaCJ9.FCV2mpRq2iULMEZJbBi0Iw';
  const GOOGLE_MAPS_KEY = "AIzaSyBdVVKVelSKtsN9F6wTh-S57j-r1TbvNXw";

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/jacquelickteig/cm19xymc400tt01pde8ul6loi',
    center: [-98.5795, 39.8283],
    zoom: 3
  });

  let originalGeojson = null;
  let uploadedLayerId = "uploaded-layer";

  map.on('load', async () => {
    try {
      const datasetUrl = 'https://api.mapbox.com/datasets/v1/jacquelickteig/cmehl5mrh2qmv1nkae937qkrh/features?access_token=' + mapboxgl.accessToken;
      const res = await fetch(datasetUrl);
      const geojson = await res.json();
      originalGeojson = geojson;

      map.addSource('offices', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'offices-layer',
        type: 'circle',
        source: 'offices',
        paint: { 'circle-radius': 6, 'circle-color': '#009de0' }
      });

      const stateSelect = document.getElementById('stateFilter');
      const provinceSelect = document.getElementById('provinceFilter');
      const buSelect = document.getElementById('buFilter');

      const states = [...new Set(geojson.features.filter(f => f.properties.country === "US").map(f => f.properties.state).filter(Boolean))].sort();
      const provinces = [...new Set(geojson.features.filter(f => f.properties.country === "CAN").map(f => f.properties.state).filter(Boolean))].sort();
      const bus = [...new Set(geojson.features.map(f => f.properties.bu).filter(Boolean))].sort();

      states.forEach(s => { const opt=document.createElement('option'); opt.value=s; opt.textContent=s; stateSelect.appendChild(opt); });
      provinces.forEach(p => { const opt=document.createElement('option'); opt.value=p; opt.textContent=p; provinceSelect.appendChild(opt); });
      bus.forEach(b => { const opt=document.createElement('option'); opt.value=b; opt.textContent=b; buSelect.appendChild(opt); });

      function getSelectedValues(select) {
        return Array.from(select.selectedOptions).map(opt => opt.value);
      }

      function applyFilters() {
        const selectedStates = getSelectedValues(stateSelect);
        const selectedProvinces = getSelectedValues(provinceSelect);
        const selectedBUs = getSelectedValues(buSelect);

        const filtered = {
          type: 'FeatureCollection',
          features: originalGeojson.features.filter(f => {
            const props = f.properties;
            let match = true;

            if (selectedStates.length > 0 && props.country === "US" && !selectedStates.includes(props.state)) match = false;
            if (selectedProvinces.length > 0 && props.country === "CAN" && !selectedProvinces.includes(props.state)) match = false;
            if (selectedStates.length > 0 && props.country === "CAN") match = false; // hide Canada when states are picked
            if (selectedProvinces.length > 0 && props.country === "US") match = false; // hide US when provinces are picked
            if (selectedBUs.length > 0 && !selectedBUs.includes(props.bu)) match = false;

            return match;
          })
        };
        map.getSource('offices').setData(filtered);
      }

      stateSelect.addEventListener('change', applyFilters);
      provinceSelect.addEventListener('change', applyFilters);
      buSelect.addEventListener('change', applyFilters);

      document.getElementById('clearFilters').addEventListener('click', () => {
        stateSelect.selectedIndex = -1;
        provinceSelect.selectedIndex = -1;
        buSelect.selectedIndex = -1;
        map.getSource('offices').setData(originalGeojson);
      });

      const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });
      map.on('mouseenter', 'offices-layer', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const props = e.features[0].properties;
        const html = `<span style="font-weight:bold; color:#009DE0;">${props.officeName || ''}</span><br>${props.address || ''}<br>${props.phone || ''}`;
        popup.setLngLat(e.features[0].geometry.coordinates).setHTML(html).addTo(map);
      });
      map.on('mouseleave', 'offices-layer', () => { map.getCanvas().style.cursor = ''; popup.remove(); });

      // Upload CSV with geocoding
      document.getElementById('csvUpload').addEventListener('change', function(e){
        const file = e.target.files[0];
        if (!file) return;
        const color = document.getElementById('colorPicker').value;

        Papa.parse(file, {
          header: true,
          complete: async function(results) {
            const features = [];

            for (const row of results.data) {
              let lat = parseFloat(row.Latitude);
              let lng = parseFloat(row.Longitude);

              // Geocode if no lat/lng
              if ((!lat || !lng) && row.ADDRESS) {
                try {
                  const response = await fetch(
                    `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(row.ADDRESS)}&key=${GOOGLE_MAPS_KEY}`
                  );
                  const data = await response.json();
                  if (data.status === "OK") {
                    lat = data.results[0].geometry.location.lat;
                    lng = data.results[0].geometry.location.lng;
                  }
                } catch (err) {
                  console.error("Geocoding failed for:", row.ADDRESS, err);
                }
              }

              if (lat && lng) {
                features.push({
                  type: "Feature",
                  geometry: { type: "Point", coordinates: [lng, lat] },
                  properties: {
                    officeName: row["Client and Project Name"],
                    address: row.ADDRESS,
                    state: row["STATE / PROVINCE"]
                  }
                });
              }
            }

            const uploadedGeojson = { type:"FeatureCollection", features };

            if (map.getLayer(uploadedLayerId)) {
              map.removeLayer(uploadedLayerId);
              map.removeSource(uploadedLayerId);
            }
            map.addSource(uploadedLayerId, { type:"geojson", data: uploadedGeojson });
            map.addLayer({
              id: uploadedLayerId,
              type: "circle",
              source: uploadedLayerId,
              paint: { "circle-radius": 6, "circle-color": color }
            });

            map.on('mouseenter', uploadedLayerId, (e) => {
              map.getCanvas().style.cursor = 'pointer';
              const props = e.features[0].properties;
              popup.setLngLat(e.features[0].geometry.coordinates).setHTML(
                `<span style="font-weight:bold; color:#009DE0;">${props.officeName || ''}</span><br>${props.address || ''}`
              ).addTo(map);
            });
            map.on('mouseleave', uploadedLayerId, () => { map.getCanvas().style.cursor = ''; popup.remove(); });
          }
        });
      });

      // Revert to original map
      document.getElementById('revertMap').addEventListener('click', () => {
        if (map.getLayer(uploadedLayerId)) {
          map.removeLayer(uploadedLayerId);
          map.removeSource(uploadedLayerId);
        }
      });

    } catch (err) {
      console.error('Error loading dataset:', err);
    }
  });
</script>
</body>
</html>
