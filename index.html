<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Salas O'Brien Offices Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- html2canvas for export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  
  <!-- Pickr (Color Picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    #filters {
      position:absolute;
      top:10px; left:10px;
      background:#fff; padding:10px; border-radius:4px;
      font-family:sans-serif; z-index:1;
      max-width:260px;
    }
    label { font-weight:bold; margin-bottom:8px; }
    .subhead { font-weight:normal; font-size:12px; display:block; margin-top:-2px; }
    select { margin:5px 0; width:100%; }
    button { margin:5px 0; padding:5px 10px; width:100%; }
    input[type="file"] { margin:5px 0; width:100%; }
    #color-picker { margin:5px 0; }
    .mapboxgl-popup { font-family: sans-serif; font-size: 13px; }
    .mapboxgl-popup-content { white-space: pre-line; }
  </style>
</head>
<body>
<div id="filters">
  <label>Filter by State/Province</label>
  <span class="subhead">(hold Ctrl + click to select multiple states/provinces)</span>
  <select id="regionFilter" multiple size="10"></select><br>
  <button id="clearRegion">Clear State/Province</button>
  <br><br>

  <label>Filter by Business Unit</label><br>
  <select id="buFilter" multiple size="5"></select><br>
  <button id="clearBU">Clear Business Unit</button>
  <br><br>

  <button id="clearFilters">Clear All Filters</button>
  <br><br>
  <hr>
  <br>
</div>
  <label>Additional Addresses</label>
<span class="subhead">Upload a .csv file of client or project locations</span>
  <input type="file" id="csvUpload" accept=".csv"><br>
<a href="#" id="downloadTemplate" style="display:inline-block; margin-top:6px; font-size:13px; text-decoration:underline; color:#009de0; cursor:pointer;">
  download template
</a>
  <br>
<br>
  <label>Marker Color <br><span class="subhead">(for uploaded addresses)</span></label><br>
  <div id="color-picker"></div><br>
<hr><br>
  <button id="revertMap">Revert to Original Map</button>
<br>
  <button id="exportMap">Export Map as PNG</button>
</div>
<div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoiamFjcXVlbGlja3RlaWciLCJhIjoiY21lZDF0aXE0MDVrYzJpcGxxYWJjcjBkaCJ9.FCV2mpRq2iULMEZJbBi0Iw';
  const GOOGLE_MAPS_KEY = "AIzaSyBdVVKVelSKtsN9F6wTh-S57j-r1TbvNXw";

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/jacquelickteig/cm19xymc400tt01pde8ul6loi',
    center: [-98.5795, 39.8283],
    zoom: 3
  });

  let originalGeojson = null;
  let uploadedLayerId = "uploaded-layer";
  let currentMarkerColor = "#000086"; // default color

  // Init Pickr
  const pickr = Pickr.create({
    el: '#color-picker',
    theme: 'classic',
    default: currentMarkerColor,
    components: {
      preview: true,
      opacity: false,
      hue: true,
      interaction: {
        hex: true,
        input: true,
        save: true
      }
    }
  });

  pickr.on('save', (color) => {
    currentMarkerColor = color.toHEXA().toString();
    if (map.getLayer(uploadedLayerId)) {
      map.setPaintProperty(uploadedLayerId, 'circle-color', currentMarkerColor);
    }
  });

  map.on('load', async () => {
    try {
      const datasetUrl = 'https://api.mapbox.com/datasets/v1/jacquelickteig/cmehl5mrh2qmv1nkae937qkrh/features?access_token=' + mapboxgl.accessToken;
      const res = await fetch(datasetUrl);
      const geojson = await res.json();
      originalGeojson = geojson;

      map.addSource('offices', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'offices-layer',
        type: 'circle',
        source: 'offices',
        paint: { 'circle-radius': 6, 'circle-color': '#009de0' }
      });

      const regionSelect = document.getElementById('regionFilter');
      const buSelect = document.getElementById('buFilter');

      const states = [...new Set(geojson.features.filter(f => f.properties.country === "US").map(f => f.properties.state).filter(Boolean))].sort();
      const provinces = [...new Set(geojson.features.filter(f => f.properties.country === "CAN").map(f => f.properties.state).filter(Boolean))].sort();
      const bus = [...new Set(geojson.features.map(f => f.properties.bu).filter(Boolean))].sort();

      const usGroup = document.createElement('optgroup');
      usGroup.label = "United States";
      states.forEach(s => { 
        const opt=document.createElement('option'); 
        opt.value="US|"+s; 
        opt.textContent=s; 
        usGroup.appendChild(opt); 
      });

      const caGroup = document.createElement('optgroup');
      caGroup.label = "Canada";
      provinces.forEach(p => { 
        const opt=document.createElement('option'); 
        opt.value="CAN|"+p; 
        opt.textContent=p; 
        caGroup.appendChild(opt); 
      });

      regionSelect.appendChild(usGroup);
      regionSelect.appendChild(caGroup);

      bus.forEach(b => { 
        const opt=document.createElement('option'); 
        opt.value=b; 
        opt.textContent=b; 
        buSelect.appendChild(opt); 
      });

      function getSelectedValues(select) {
        return Array.from(select.selectedOptions).map(opt => opt.value);
      }

      function applyFilters() {
        const selectedRegions = getSelectedValues(regionSelect); 
        const selectedBUs = getSelectedValues(buSelect);

        const filtered = {
          type: 'FeatureCollection',
          features: originalGeojson.features.filter(f => {
            const props = f.properties;
            let match = true;

            if (selectedRegions.length > 0) {
              const regionCode = props.country + "|" + props.state;
              if (!selectedRegions.includes(regionCode)) match = false;
            }

            if (selectedBUs.length > 0 && !selectedBUs.includes(props.bu)) match = false;

            return match;
          })
        };

        map.getSource('offices').setData(filtered);
      }

      regionSelect.addEventListener('change', applyFilters);
      buSelect.addEventListener('change', applyFilters);

      document.getElementById('clearFilters').addEventListener('click', () => {
        regionSelect.selectedIndex = -1;
        buSelect.selectedIndex = -1;
        map.getSource('offices').setData(originalGeojson);
      });

      // Clear State/Province filter only
document.getElementById('clearRegion').addEventListener('click', () => {
  document.getElementById('regionFilter').selectedIndex = -1;
  applyFilters();
});

// Clear Business Unit filter only
document.getElementById('clearBU').addEventListener('click', () => {
  document.getElementById('buFilter').selectedIndex = -1;
  applyFilters();
});


      const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });
      map.on('mouseenter', 'offices-layer', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        const props = e.features[0].properties;
        const html = `<span style="font-weight:bold; color:#009DE0;">${props.officeName || ''}</span><br>${props.address || ''}<br>${props.phone || ''}`;
        popup.setLngLat(e.features[0].geometry.coordinates).setHTML(html).addTo(map);
      });
      map.on('mouseleave', 'offices-layer', () => { map.getCanvas().style.cursor = ''; popup.remove(); });

      // Upload CSV with geocoding
      document.getElementById('csvUpload').addEventListener('change', function(e){
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
          header: true,
          complete: async function(results) {
            const features = [];

            for (const row of results.data) {
              let lat = parseFloat(row.Latitude);
              let lng = parseFloat(row.Longitude);

              if ((!lat || !lng) && row.ADDRESS) {
                try {
                  const response = await fetch(
                    `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(row.ADDRESS)}&key=${GOOGLE_MAPS_KEY}`
                  );
                  const data = await response.json();
                  if (data.status === "OK") {
                    lat = data.results[0].geometry.location.lat;
                    lng = data.results[0].geometry.location.lng;
                  }
                } catch (err) {
                  console.error("Geocoding failed for:", row.ADDRESS, err);
                }
              }

              if (lat && lng) {
                features.push({
                  type: "Feature",
                  geometry: { type: "Point", coordinates: [lng, lat] },
                  properties: {
                    officeName: row["Client and Project Name"],
                    address: row.ADDRESS,
                    state: row["STATE / PROVINCE"]
                  }
                });
              }
            }

            const uploadedGeojson = { type:"FeatureCollection", features };

            if (map.getLayer(uploadedLayerId)) {
              map.removeLayer(uploadedLayerId);
              map.removeSource(uploadedLayerId);
            }
            map.addSource(uploadedLayerId, { type:"geojson", data: uploadedGeojson });
            map.addLayer({
              id: uploadedLayerId,
              type: "circle",
              source: uploadedLayerId,
              paint: { "circle-radius": 6, "circle-color": currentMarkerColor }
            });

            map.on('mouseenter', uploadedLayerId, (e) => {
              map.getCanvas().style.cursor = 'pointer';
              const props = e.features[0].properties;
              popup.setLngLat(e.features[0].geometry.coordinates).setHTML(
                `<span style="font-weight:bold; color:#009DE0;">${props.officeName || ''}</span><br>${props.address || ''}`
              ).addTo(map);
            });
            map.on('mouseleave', uploadedLayerId, () => { map.getCanvas().style.cursor = ''; popup.remove(); });
          }
        });
      });

      // Revert to original map
      document.getElementById('revertMap').addEventListener('click', () => {
        if (map.getLayer(uploadedLayerId)) {
          map.removeLayer(uploadedLayerId);
          map.removeSource(uploadedLayerId);
        }
        regionSelect.selectedIndex = -1;
        buSelect.selectedIndex = -1;
        pickr.setColor("#000086");
        currentMarkerColor = "#000086";
        document.getElementById('csvUpload').value = "";
        map.getSource('offices').setData(originalGeojson);
      });

      // Export to PNG
      document.getElementById('exportMap').addEventListener('click', () => {
        const mapContainer = document.getElementById('map');
        html2canvas(mapContainer, { useCORS: true }).then(canvas => {
          const img = canvas.toDataURL("image/png");
          const link = document.createElement('a');
          link.href = img;
          link.download = "map-export.png";
          link.click();
        });
      });

    } catch (err) {
      console.error('Error loading dataset:', err);
    }
  });

// Force Template CSV download
document.getElementById('downloadTemplate').addEventListener('click', async (e) => {
  e.preventDefault(); // prevent navigation
  const url = "https://raw.githubusercontent.com/JLickteig/SalasOBrienOfficeMap/refs/heads/main/MapAddressTemplate.csv";
  try {
    const response = await fetch(url);
    const blob = await response.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "MapAddressTemplate.csv"; // ✅ forces save as CSV
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  } catch (err) {
    console.error("Failed to download template:", err);
  }
});


</script>
</body>
</html>





