<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Salas O'Brien Offices Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Pickr -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

  <style>
    body,html {margin:0;padding:0;height:100%;}
    #map {position:absolute;top:0;bottom:0;width:100%;}
    #panel {position:absolute;top:14px;left:14px;z-index:5;background:#fff;padding:10px;border-radius:8px;}
    .layer-card {border:1px solid #ccc;padding:8px;margin:6px 0;}
    .pickr .pcr-button {width:24px;height:24px;border-radius:4px;}
    .map-legend {position:absolute;left:50%;transform:translateX(-50%);bottom:14px;
      background:rgba(255,255,255,0.95);padding:6px 10px;border-radius:6px;z-index:4;}
    #legendItems{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;}
    .legend-item{display:flex;align-items:center;gap:4px;}
    .legend-swatch{width:14px;height:14px;border:1px solid #666;}
  </style>
</head>
<body>
  <aside id="panel">
    <button id="addLayerBtn">+ Add Layer</button>
    <button id="exportMap">Export PNG</button>
    <div id="uploadLayers"></div>
  </aside>
  <div id="map"></div>
  <div id="legend" class="map-legend" style="display:none;">
    <div id="legendItems"></div>
  </div>

<script>
mapboxgl.accessToken = 'YOUR_PUBLIC_TOKEN';
const map = new mapboxgl.Map({
  container:'map',
  style:'mapbox://styles/mapbox/streets-v11',
  center:[-98.5795,39.8283], zoom:3, preserveDrawingBuffer:true
});

let layerCount=0, uploadLayers=[];
function updateLegend(){
  const legend=document.getElementById('legend');
  const items=document.getElementById('legendItems');
  items.innerHTML='';
  if(!uploadLayers.length){legend.style.display='none';return;}
  legend.style.display='';
  uploadLayers.forEach(l=>{
    if(!l.visible) return;
    const color=l.pickr.getColor().toHEXA().toString();
    const div=document.createElement('div');
    div.className='legend-item';
    div.innerHTML=`<span class="legend-swatch" style="background:${color}"></span><span>${l.name()}</span>`;
    items.appendChild(div);
  });
}

document.getElementById('addLayerBtn').onclick=()=>addUploadLayer();
function addUploadLayer(){
  layerCount++;
  const id='layer'+layerCount;
  const circleId=id+'-circle';
  const color='#'+Math.floor(Math.random()*16777215).toString(16);
  // UI
  const card=document.createElement('div');
  card.className='layer-card';
  card.innerHTML=`<input id="name-${id}" value="Layer ${layerCount}" style="width:120px;">
  <div id="picker-${id}"></div>`;
  document.getElementById('uploadLayers').appendChild(card);
  // Source/layer
  map.addSource(id,{type:'geojson',data:{type:'FeatureCollection',features:[]}});
  map.addLayer({id:circleId,type:'circle',source:id,paint:{'circle-radius':6,'circle-color':color}});
  // Pickr
  const pickr=Pickr.create({el:`#picker-${id}`,theme:'classic',default:color,
    components:{preview:true,opacity:false,hue:true,interaction:{hex:true,input:true}}});
  pickr.on('init',()=>{pickr.setColor(color);});
  pickr.on('change',c=>{
    const hex=c.toHEXA().toString();
    document.querySelector(`#picker-${id} .pcr-button`).style.background=hex;
    map.setPaintProperty(circleId,'circle-color',hex);
    updateLegend();
  });
  // Track
  uploadLayers.push({
    id,circleId,pickr,
    name:()=>document.getElementById(`name-${id}`).value,
    get visible(){return map.getLayoutProperty(circleId,'visibility')!=='none';}
  });
  updateLegend();
}

// Export fix
document.getElementById('exportMap').onclick=async()=>{
  const mapCanvas=map.getCanvas();
  const exportCanvas=document.createElement('canvas');
  exportCanvas.width=2048; exportCanvas.height=1536;
  const ctx=exportCanvas.getContext('2d');
  ctx.drawImage(mapCanvas,0,0,exportCanvas.width,exportCanvas.height);
  // Draw legend at on-screen position
  const legend=document.getElementById('legend');
  if(legend && legend.style.display!=='none'){
    const legendCanvas=await html2canvas(legend,{backgroundColor:null,scale:2});
    const rect=legend.getBoundingClientRect();
    const mapRect=mapCanvas.getBoundingClientRect();
    const scaleX=mapCanvas.width/mapRect.width;
    const scaleY=mapCanvas.height/mapRect.height;
    const dx=(rect.left-mapRect.left)*scaleX;
    const dy=(rect.top-mapRect.top)*scaleY;
    const dw=rect.width*scaleX;
    const dh=rect.height*scaleY;
    ctx.drawImage(legendCanvas,dx,dy,dw,dh);
  }
  const link=document.createElement('a');
  link.href=exportCanvas.toDataURL('image/png');
  link.download='map.png'; link.click();
};
</script>
</body>
</html>
